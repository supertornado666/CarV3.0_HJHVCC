/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2024 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "adc.h"
#include "tim.h"
#include "usart.h"
#include "gpio.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "oled.h"
#include "motor.h"
#include "niming.h"
#include "pid.h"
#include "cJSON.h"
#include <string.h>
#include <stdio.h>
#include "HC_SR04.h"

#include "mpu6050.h"
#include "inv_mpu.h"
#include "inv_mpu_dmp_motion_driver.h"
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */

/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */
cJSON *cJsonData ,*cJsonVlaue;	//‰∏ä‰ΩçÊú∫ÈúÄË¶ÅÁöÑÂèÇÊï∞
float p,i,d,a,b;				//ÂèëÈ?ÅÂà∞‰∏ä‰ΩçÊú∫ÁöÑpidÂèÇÊï∞
extern float Mileage;			//ÈáåÁ®ã
uint8_t OLEDString[50];			//OLEDÊòæÁ§∫ÁöÑÂ≠óÁ¨¶‰∏≤
uint8_t Usart3String[50];		//‰∏≤Âè£3ÊòæÁ§∫ÁöÑÂ≠óÁ¨¶‰∏≤
uint8_t g_ucaHW_Read[4] = {0};	//‰øùÂ≠òÁ∫¢Â§ñÂØπÁÆ°ÁîµÂπ≥ÁöÑÊï∞Áª?
int8_t g_cThisState = 0;		//ËøôÊ¨°Áä∂Ê??
int8_t g_cLastState = 0; 		//‰∏äÊ¨°Áä∂Ê??
float g_fHW_PID_Out;			//Á∫¢Â§ñÂØπÁÆ°PIDËÆ°ÁÆóËæìÂá∫ÈÄüÂ∫¶
float g_fHW_PID_Out1;			//ÁîµÊú∫1ÁöÑÊúÄÂêéÂæ™ËøπPIDÊéßÂà∂ÈÄüÂ∫¶
float g_fHW_PID_Out2;			//ÁîµÊú∫2ÁöÑÊúÄÂêéÂæ™ËøπPIDÊéßÂà∂ÈÄüÂ∫¶
float g_fHC_SR04_Read;			//Ë∑üÈöèÂäüËÉΩÂÆûÈôÖË∑ùÁ¶ª
float g_fFollow_PID_Out;		//Ë∑üÈöèÂäüËÉΩÂ∫îËÆæÈÄüÂ∫¶
uint8_t g_ucUsart3ReceiveData;  //‰øùÂ≠ò‰∏≤Âè£‰∏âÊé•Êî∂ÁöÑÊï∞ÊçÆ
uint8_t Car_Mode = 0;			//Ê®°Âºè

float pitch,roll,yaw; //‰øØ‰ª∞Ëß? ÁøªÊªöËß? Ëà™ÂêëËß?
float  g_fMPU6050YawMovePidOut = 0.00f; //ÂßøÊÄÅPIDËøêÁÆóËæìÂá∫
float  g_fMPU6050YawMovePidOut1 = 0.00f; //Á¨¨‰∏Ä‰∏™ÁîµÊú∫ÊéßÂà∂ËæìÂá∫
float  g_fMPU6050YawMovePidOut2 = 0.00f; //Á¨¨‰∏Ä‰∏™ÁîµÊú∫ÊéßÂà∂ËæìÂá∫
/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/

/* USER CODE BEGIN PV */

/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{

  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_USART1_UART_Init();
  MX_TIM1_Init();
  MX_TIM2_Init();
  MX_TIM4_Init();
  MX_ADC2_Init();
  MX_USART3_UART_Init();
  /* USER CODE BEGIN 2 */
	OLED_Init();
	OLED_Clear();
	PID_Init();

	HAL_Delay(500);//Âª∂Êó∂0.5Áßí 6050‰∏äÁîµÁ®≥ÂÆöÂêéÂàùÂßãÂåñ
	MPU_Init();//ÂàùÂßãÂåñMPU6050
	while(MPU_Init()!=0);
	while(mpu_dmp_init()!=0);

	HAL_TIM_PWM_Start(&htim1,TIM_CHANNEL_1);//Âº?ÂêØÂÆöÊó∂Âô®1 ÈÄöÈÅì1 PWMËæìÂá∫
	HAL_TIM_PWM_Start(&htim1,TIM_CHANNEL_4);//Âº?ÂêØÂÆöÊó∂Âô®1 ÈÄöÈÅì4 PWMËæìÂá∫
	HAL_TIM_Encoder_Start(&htim2,TIM_CHANNEL_ALL);	//Âº?ÂêØÂÆöÊó∂Âô®2
	HAL_TIM_Encoder_Start(&htim4,TIM_CHANNEL_ALL);	//Âº?ÂêØÂÆöÊó∂Âô®4
	HAL_TIM_Base_Start_IT(&htim2);					//Âº?ÂêØÂÆöÊó∂Âô®2 ‰∏≠Êñ≠
	HAL_TIM_Base_Start_IT(&htim4);                	//Âº?ÂêØÂÆöÊó∂Âô®4 ‰∏≠Êñ≠
	HAL_TIM_Base_Start_IT(&htim1);                //Âº?ÂêØÂÆöÊó∂Âô®1 ‰∏≠Êñ≠
	__HAL_UART_ENABLE_IT(&huart1,UART_IT_RXNE);	//Âº?ÂêØ‰∏≤Âè?1Êé•Êî∂‰∏≠Êñ≠
	HAL_UART_Receive_IT(&huart3,&g_ucUsart3ReceiveData,1);  //‰∏≤Âè£‰∏âÊé•Êî∂Êï∞Êç?

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
	  
/**************************Âõ∫ÂÆöÊòæÁ§∫ÂΩìÂâçÊ®°Âºè*****************************************************/
	sprintf((char *)OLEDString,"Mode:%d",Car_Mode);//Ê®°Âºè
	OLED_ShowString(0,6,OLEDString,12);

	HAL_UART_Transmit(&huart3,( uint8_t *)Usart3String,strlen(( const  char *)Usart3String),50);//ÈòªÂ°ûÂºèÂèëÈÄÅÈøöËøá‰∏≤Âè£‰∏âËæìÂá∫Â≠óÁ¨ø strlen:ËÆ°ÁÆóÂ≠óÁ¨¶‰∏≤Â§ßÂ∞ø
	sprintf((char *)Usart3String,"Mode:%d\r\n",Car_Mode);//ÊòæÁ§∫ÂΩìÂâçÊ®°Âºè
/**************************Âõ∫ÂÆöÊòæÁ§∫ÂΩìÂâçÊ®°Âºè*****************************************************/

	if (Car_Mode == 0){
		Motor_SetSpeed(0,0);
/**************************OLEDÊòæÁ§∫‰ø°ÊÅØ*****************************************************/
		sprintf((char *)OLEDString,"v1:%.2f v2:%.2f",Motor1_Speed,Motor2_Speed);//Â≠óÁ¨¶‰∏≤Ê†ºÂºèÂåñÔºå‰∏§ÁîµÊú∫ÈÄüÂ∫¶
		OLED_ShowString(0,0,OLEDString,12);
		sprintf((char *)OLEDString,"Mileage:%.2f",Mileage);//ÈáåÁ®ã
		OLED_ShowString(0,1,OLEDString,12);
		sprintf((char *)OLEDString,"Battery:%.2fV",adcGetBatteryVoltage());//ÁîµÊ±†ÁîµÂéã
		OLED_ShowString(0,2,OLEDString,12);
		sprintf((char *)OLEDString,"HC_SR04:%.2fcm\r\n",HC_SR04_Read());//ÈöúÁ¢çÁâ©Ë∑ùÁ¶ª
		OLED_ShowString(0,3,OLEDString,12);
		sprintf((char *)OLEDString,"p:%.2f r:%.2f \r\n",pitch,roll);//‰øØ‰ª∞Ëßí ÁøªÊªöËßí
		OLED_ShowString(0,4,OLEDString,12);
		sprintf((char *)OLEDString,"y:%.2f  \r\n",yaw);//Ëà™ÂêëËßí
		OLED_ShowString(0,5,OLEDString,12);
/**************************OLEDÊòæÁ§∫‰ø°ÊÅØ*****************************************************/
	  
/**************************‰∏≤Âè£3/ËìùÁâôÊòæÁ§∫‰ø°ÊÅØ*****************************************************/  
		sprintf((char *)Usart3String,"v1:%.2fv2:%.2f\r\n",Motor1_Speed,Motor2_Speed);//ÊòæÁ§∫‰∏§‰∏™ÁîµÊú∫ËΩ¨Èøø Âçï‰ΩçÔºöËΩ¨/Áß?
		HAL_UART_Transmit(&huart3,( uint8_t *)Usart3String,strlen(( const  char *)Usart3String),50);//ÈòªÂ°ûÂºèÂèëÈÄÅÈøöËøá‰∏≤Âè£‰∏âËæìÂá∫Â≠óÁ¨ø strlen:ËÆ°ÁÆóÂ≠óÁ¨¶‰∏≤Â§ßÂ∞?
		sprintf((char *)Usart3String,"Mileage%.2fcm\r\n",Mileage);//ËÆ°ÁÆóÂ∞èËΩ¶ÈáåÁ®ã Âçï‰Ωçcm
		HAL_UART_Transmit(&huart3,( uint8_t *)Usart3String,strlen(( const  char *)Usart3String),50);//ÈòªÂ°ûÂºèÂèëÈÄÅÈøöËøá‰∏≤Âè£‰∏âËæìÂá∫Â≠óÁ¨ø strlen:ËÆ°ÁÆóÂ≠óÁ¨¶‰∏≤Â§ßÂ∞?
		sprintf((char *)Usart3String,"Battery:%.2fV\r\n",adcGetBatteryVoltage());//ÊòæÁ§∫ÁîµÊ±†ÁîµÂéã
		HAL_UART_Transmit(&huart3,( uint8_t *)Usart3String,strlen(( const  char *)Usart3String),50);//ÈòªÂ°ûÂºèÂèëÈÄÅÈøöËøá‰∏≤Âè£‰∏âËæìÂá∫Â≠óÁ¨ø strlen:ËÆ°ÁÆóÂ≠óÁ¨¶‰∏≤Â§ßÂ∞?
		sprintf((char *)Usart3String,"HC_SR04:%.2fcm\r\n",HC_SR04_Read());//ÊòæÁ§∫Ë∂ÖÂ£∞Ê≥¢Êï∞Êç?
		HAL_UART_Transmit(&huart3,( uint8_t *)Usart3String,strlen(( const  char *)Usart3String),50);//ÈÄöËøá‰∏≤Âè£‰∏âËæìÂá∫Â≠óÁ¨? strlen:ËÆ°ÁÆóÂ≠óÁ¨¶‰∏≤Â§ßÂ∞?	
		
		while(mpu_dmp_get_data(&pitch,&roll,&yaw)!=0){}  //Ëøô‰∏™ÂèØ‰ª•Ëß£ÂÜ≥ÁªèÂ∏∏ËØª‰∏çÂá∫Êï∞ÊçÆÁöÑÈóÆÈ¢ò
		sprintf((char *)Usart3String,"pitch:%.2f roll:%.2f yaw:%.2f\r\n",pitch,roll,yaw);//ÊòæÁ§∫6050Êï∞ÊçÆ
		HAL_UART_Transmit(&huart3,( uint8_t *)Usart3String,strlen(( const  char *)Usart3String),50);//ÈÄöËøá‰∏≤Âè£‰∏âËæìÂá∫Â≠óÁ¨? strlen:ËÆ°ÁÆóÂ≠óÁ¨¶‰∏≤Â§ßÂ∞?	
/**************************‰∏≤Âè£3/ËìùÁâôÊòæÁ§∫‰ø°ÊÅØ*****************************************************/ 	  
	}

	if (Car_Mode == 1){
/**************************Á∫¢Â§ñÂæ™ËøπÂäüËÉΩ*****************************************************/
		g_ucaHW_Read[0] = READ_HW_OUT_1;//ËØªÂèñÁ∫¢Â§ñÂØπÁÆ°Áä∂Ê?Å„?ÅËøôÊ†∑Áõ∏ÊØî‰∫éÂÜôÂú®ifÈáåÈù¢Êõ¥È´òÊï?
		g_ucaHW_Read[1] = READ_HW_OUT_2;
		g_ucaHW_Read[2] = READ_HW_OUT_3;
		g_ucaHW_Read[3] = READ_HW_OUT_4;

		if(g_ucaHW_Read[0] == 0&&g_ucaHW_Read[1] == 0&&g_ucaHW_Read[2] == 0&&g_ucaHW_Read[3] == 0 )
		{
			g_cThisState = 0;//Áõ¥Ë°å
		}
		else if(g_ucaHW_Read[0] == 0&&g_ucaHW_Read[1] == 1&&g_ucaHW_Read[2] == 0&&g_ucaHW_Read[3] == 0 )
		{
			g_cThisState = -1;//Â∫îËØ•Âè≥ÂÅè
		}
		else if(g_ucaHW_Read[0] == 1&&g_ucaHW_Read[1] == 0&&g_ucaHW_Read[2] == 0&&g_ucaHW_Read[3] == 0 )
		{
			g_cThisState = -2;//Âø´È?üÂè≥ÂÅ?
		}
		else if(g_ucaHW_Read[0] == 1&&g_ucaHW_Read[1] == 1&&g_ucaHW_Read[2] == 0&&g_ucaHW_Read[3] == 0 )
		{
			g_cThisState = -3;//Âè≥ËΩ¨Âº?
		}
		else if(g_ucaHW_Read[0] == 0&&g_ucaHW_Read[1] == 0&&g_ucaHW_Read[2] == 1&&g_ucaHW_Read[3] == 0 )
		{
			g_cThisState = 1;//Â∫îËØ•Â∑¶ÂÅè	
		}
		else if(g_ucaHW_Read[0] == 0&&g_ucaHW_Read[1] == 0&&g_ucaHW_Read[2] == 0&&g_ucaHW_Read[3] == 1 )
		{
			g_cThisState = 2;//Âø´È?üÂ∑¶ÂÅ?
		}
		else if(g_ucaHW_Read[0] == 0&&g_ucaHW_Read[1] == 0&&g_ucaHW_Read[2] == 1&&g_ucaHW_Read[3] == 1 )
		{
			g_cThisState = 3;//Â∑¶ËΩ¨Âº?
		}
		g_fHW_PID_Out = PID_Realize(&pidHW_Tracking,g_cThisState);//PIDËÆ°ÁÆóËæìÂá∫ÁõÆÊ†áÈÄüÂ∫¶ Ëøô‰∏™ÈÄüÂ∫¶Ôºå‰ºöÂíåÂü∫Á°?ÈÄüÂ∫¶Âä†Âáè

		g_fHW_PID_Out1 = 3 + g_fHW_PID_Out;//ÁîµÊú∫1ÈÄüÂ∫¶=Âü∫Á°ÄÈÄüÂ∫¶+Âæ™ËøπPIDËæìÂá∫ÈÄüÂ∫¶
		g_fHW_PID_Out2 = 3 - g_fHW_PID_Out;//ÁîµÊú∫2ÈÄüÂ∫¶=Âü∫Á°ÄÈÄüÂ∫¶-Âæ™ËøπPIDËæìÂá∫ÈÄüÂ∫¶ÔºåÂõ†‰∏∫Ë¥üÂÄºÂè≥ËΩ¨Ê≠£ÂÄºÂ∑¶ËΩ?
		if(g_fHW_PID_Out1 > 5) g_fHW_PID_Out1 = 5;//ËøõË°åÈôêÂπÖ ÈôêÂπÖÈÄüÂ∫¶Âú?0-5‰πãÈó¥
		if(g_fHW_PID_Out1 < 0) g_fHW_PID_Out1 = 0;
		if(g_fHW_PID_Out2 > 5) g_fHW_PID_Out2 = 5;
		if(g_fHW_PID_Out2 < 0) g_fHW_PID_Out2 = 0;
		if(g_cThisState != g_cLastState)//Â¶ÇÊûúËøôÊ¨°Áä∂Ê?Å‰∏çÁ≠â‰∫é‰∏äÊ¨°Áä∂Ê?Å„?ÅÂ∞±ËøõË°åÊîπÂèòÁõÆÊ†áÈÄüÂ∫¶ÂíåÊéßÂà∂ÁîµÊú∫„?ÅÂú®ÂÆöÊó∂Âô®‰∏≠‰æùÊóßÂÆöÊó∂ÊéßÂà∂ÁîµÊú∫
		{
			Motor_SetSpeed(g_fHW_PID_Out1,g_fHW_PID_Out2);//ÈÄöËøáËÆ°ÁÆóÁöÑÈ?üÂ∫¶ÊéßÂà∂ÁîµÊú∫
		}

		g_cLastState = g_cThisState;//‰øùÂ≠ò‰∏äÊ¨°Á∫¢Â§ñÂØπÁÆ°Áä∂Ê??
/**************************Á∫¢Â§ñÂæ™ËøπÂäüËÉΩ*****************************************************/
	}
	
	if (Car_Mode == 2){
/****************************ÈÅ•ÊéßÊ®°Âºè*****************************************************/
					/*Âú®stm32f1xx_it.c‰∏≠ÊâßË°å*/
/****************************ÈÅ•ÊéßÊ®°Âºè*****************************************************/
	}
	
	if (Car_Mode == 3){
/****************************ÈÅøÈöúÂäüËÉΩ*****************************************************/
		if (HC_SR04_Read() > 25){//Ëã•ÈöúÁ¢çÁâ©Â§ß‰∫é25cmÔºåÁõ¥Ë°?100ms
			Motor_SetSpeed(1,1);
			HAL_Delay(100);
		}
		else {//Âê¶ÂàôÔºåÂè≥ËΩ?400ms
			Motor_SetSpeed(-1,1);
			HAL_Delay(400);
			if (HC_SR04_Read() > 25){//Ëã•ÈöúÁ¢çÁâ©Â§ß‰∫é25cmÔºåÁõ¥Ë°?100ms
				Motor_SetSpeed(1,1);
				HAL_Delay(100);
			}
			else {//Âê¶ÂàôÔºåÂ∑¶ËΩ?800ms
				Motor_SetSpeed(1,-1);
				HAL_Delay(800);
				if (HC_SR04_Read() > 25){//Ëã•ÈöúÁ¢çÁâ©Â§ß‰∫é25cmÔºåÁõ¥Ë°?100ms
					Motor_SetSpeed(1,1);
					HAL_Delay(100);
				}
				else {//Âê¶ÂàôÔºåÂêéÈÄ?1000msÔºåÂÜçÂè≥ËΩ¨200ms
					Motor_SetSpeed(-1,-1);
					HAL_Delay(1000);
					Motor_SetSpeed(-1,1);
					HAL_Delay(200);
				}
			}
		}
/****************************ÈÅøÈöúÂäüËÉΩ*****************************************************/
	}
	
	if (Car_Mode == 4){
/****************************Ë∑üÈöèÂäüËÉΩ*****************************************************/
		g_fHC_SR04_Read = HC_SR04_Read();//ËØªÂèñÂΩìÂâçË∑ùÁ¶ª
		
		if (g_fHC_SR04_Read < 60){//ÊúâË∑üÈöèÁâ©Êó?
			g_fFollow_PID_Out = PID_Realize(&pidFollow,g_fHC_SR04_Read);//PIDËøêÁÆó
			if (g_fFollow_PID_Out > 5){g_fFollow_PID_Out = 5;}//ÈôêÂπÖ
			if (g_fFollow_PID_Out < -5){g_fFollow_PID_Out = -5;}
			if (g_fFollow_PID_Out < 1.5 && g_fFollow_PID_Out > -1.5){g_fFollow_PID_Out = 0;}
			Motor_SetSpeed(g_fFollow_PID_Out,g_fFollow_PID_Out);
		}
		else {Motor_SetSpeed(0,0);}//Êó†Ë∑üÈöèÁâ©Êó∂ÂÅúÊ≠?
		HAL_Delay(10);
/****************************Ë∑üÈöèÂäüËÉΩ*****************************************************/
	}
	
	if (Car_Mode == 5){
/***********************MPU6050Ëà™ÂêëËßíPIDÊéßÂà∂*****************************************************/
		while(mpu_dmp_get_data(&pitch,&roll,&yaw)!=0){}  //Ëøô‰∏™ÂèØ‰ª•Ëß£ÂÜ≥ÁªèÂ∏∏ËØª‰∏çÂá∫Êï∞ÊçÆÁöÑÈóÆÈ¢ò
			
		g_fMPU6050YawMovePidOut = PID_Realize(&pidMPU6050YawMovement,yaw);//PIDËÆ°ÁÆóËæìÂá∫ÁõÆÊ†áÈÄüÂ∫¶ Ëøô‰∏™ÈÄüÂ∫¶Ôºå‰ºöÂíåÂü∫Á°ÄÈÄüÂ∫¶Âä†Âáè

		g_fMPU6050YawMovePidOut1 = 1.5 + g_fMPU6050YawMovePidOut;//Âü∫Á°ÄÈÄüÂ∫¶Âä†ÂáèPIDËæìÂá∫ÈÄüÂ∫¶
		g_fMPU6050YawMovePidOut2 = 1.5 - g_fMPU6050YawMovePidOut;
		if(g_fMPU6050YawMovePidOut1 > 3.5) g_fMPU6050YawMovePidOut1 = 3.5;//ËøõË°åÈôêÂπÖ
		if(g_fMPU6050YawMovePidOut1 < 0) g_fMPU6050YawMovePidOut1 = 0;
		if(g_fMPU6050YawMovePidOut2 > 3.5) g_fMPU6050YawMovePidOut2 = 3.5;
		if(g_fMPU6050YawMovePidOut2 < 0) g_fMPU6050YawMovePidOut2 = 0;
		Motor_SetSpeed(g_fMPU6050YawMovePidOut1,g_fMPU6050YawMovePidOut2);
/***********************MPU6050Ëà™ÂêëËßíPIDÊéßÂà∂*****************************************************/
	}

/***************************ÂèëÈ?Å‰∏ä‰ΩçÊú∫******************************************************/	  
//	ANO_DT_Send_F2(Motor1_Speed*100, 3.0*100,Motor2_Speed*100,3.0*100);	//F2Â∏ßÂèëÈÄÅÂà∞‰∏ä‰ΩçÊú?
//	if(Usart_WaitReasFinish() == 0)//ÊòØÂê¶Êé•Êî∂ÂÆåÊØï
//	{
//		cJsonData  = cJSON_Parse((const char *)Usart1_ReadBuf);
//		if(cJSON_GetObjectItem(cJsonData,"p") !=NULL)
//		{
//			cJsonVlaue = cJSON_GetObjectItem(cJsonData,"p");	
//			p = cJsonVlaue->valuedouble;
//			pidMotor1Speed.Kp = p;
//			pidMotor2Speed.Kp = p;
//		}
//		if(cJSON_GetObjectItem(cJsonData,"i") !=NULL)
//		{
//			cJsonVlaue = cJSON_GetObjectItem(cJsonData,"i");	
//			i = cJsonVlaue->valuedouble;
//			pidMotor1Speed.Ki = i;
//			pidMotor2Speed.Ki = i;
//		}
//		if(cJSON_GetObjectItem(cJsonData,"d") !=NULL)
//		{
//			cJsonVlaue = cJSON_GetObjectItem(cJsonData,"d");	
//			d = cJsonVlaue->valuedouble;
//			pidMotor1Speed.Kd = d;
//			pidMotor2Speed.Kd = d;
//		}
//		if(cJSON_GetObjectItem(cJsonData,"a") !=NULL)
//		{
//		
//			cJsonVlaue = cJSON_GetObjectItem(cJsonData,"a");	
//			a = cJsonVlaue->valuedouble;
//			pidMotor1Speed.target_val =a;
//		}
//		if(cJSON_GetObjectItem(cJsonData,"b") !=NULL)
//		{
//		
//			cJsonVlaue = cJSON_GetObjectItem(cJsonData,"b");	
//			b = cJsonVlaue->valuedouble;
//			pidMotor2Speed.target_val =b;
//		}
//		if(cJsonData != NULL){
//		  cJSON_Delete(cJsonData);//ÈáäÊîæÁ©∫Èó¥„ÄÅ‰ΩÜÊòØ‰∏çËÉΩÂà†Èô§cJsonVlaue‰∏çÁÑ∂‰º? Âá∫Áé∞ÂºÇÂ∏∏ÈîôËØØ
//		}
//		memset(Usart1_ReadBuf,0,255);//Ê∏ÖÁ©∫Êé•Êî∂bufÔºåÊ≥®ÊÑèËøôÈáå‰∏çËÉΩ‰ΩøÁî®strlen	
//	}
//	printf("P:%.1f I:%.1f D:%.1f A:%.1f B:%.1f\r\n",p,i,d,a,b);
/***************************ÂèëÈ?Å‰∏ä‰ΩçÊú∫******************************************************/
		
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};
  RCC_PeriphCLKInitTypeDef PeriphClkInit = {0};

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.HSEPredivValue = RCC_HSE_PREDIV_DIV1;
  RCC_OscInitStruct.HSIState = RCC_HSI_ON;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLMUL = RCC_PLL_MUL9;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV2;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_2) != HAL_OK)
  {
    Error_Handler();
  }
  PeriphClkInit.PeriphClockSelection = RCC_PERIPHCLK_ADC;
  PeriphClkInit.AdcClockSelection = RCC_ADCPCLK2_DIV6;
  if (HAL_RCCEx_PeriphCLKConfig(&PeriphClkInit) != HAL_OK)
  {
    Error_Handler();
  }
}

/* USER CODE BEGIN 4 */

/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
